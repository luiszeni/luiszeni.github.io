<!DOCTYPE html>
<html>
<head>
	<title>Baleia √† cerveja</title>
	<style type="text/css">
    
	li{
		margin-bottom: 10px;
	}

	body {
		margin: 30px;
		padding: 15px;
		background-color: #fff;
		min-height: 0;
		-webkit-box-shadow: 0px 0px 12px 1px rgba(87, 87, 87, 0.2);
		box-shadow: 0px 0px 12px 1px rgba(87, 87, 87, 0.2);
	}


	.alert{
		padding: 15px;
		margin-bottom: 18px;
		border: 1px solid transparent;
		border-radius: 2px;
		background: lightyellow;
		color: red;
	}


	.marked{
		text-decoration: underline;
	}

	.input_area {
		border: 1px solid #cfcfcf;
		border-radius: 2px;
		background: #f7f7f7;
		line-height: 1.21429em;
		padding: 10px;
		margin-bottom: 10px;
		margin-top: 10px;
	}

	</style>
</head>
<body>

	<h1> Acesso remoto √† um servidor Linux com suporte a GPU e Docker</h1>

	Contribui√ß√µes s√£o bem-vindas. Sugira melhorias, typos, me de bitcoins!

	Este tutorial √© uma <u>tentativa</u> de registrar as coisas (comandos, artimanhas e mutretas) mais "b√°sicas" para acessar remotamente um servidor Linux que tenha suporte a GPU e Docker. Observe que eu n√£o vou entrar em detalhes  de como instalar e configurar tal ambiente.

	O Tutorial est√° separado em duas se√ß√µes:
	<ol>
		<li>Como fazer o acesso remoto com tunnelamento e montar uma pasta para acessar os arquivos no server</li>
		<li>Como usar o Docker em conjunto com a GPU</li>
	</ol>


	<h2>Acesso remoto ao servidor</h2>

	<p>Tentarei listar o que acho necess√°rio para se concectar "confort√°velmente" em um server Linux remoto usando SSH. Na verdade depois que tu te acostuma a trabalhar com estas ferramentas tu estranha ter que trabalhar "localmente" novamente. Hoje meu notebook n√£o fica mais fervendo, quem sofre esmagando os dados √© o servidor. √â provavel que algumas explica√ß√µes sejam omitidas ou (i) porque eu sou pregui√ßoso; ou (ii) porque esqueci de faz√™-lo. 

	Acessar SSH dentro de uma mesma rede usando Linux √© trivial e n√£o irei entrar em detalhes para este tipo de acesso. Aqui iremos discutir um contexto um pouco mais complexo em que existe uma m√°quina de ponto de entrada para a rede (chamaremos de <b>M√°quina Proxy</b> aqui). Em resumo, a m√°quina Proxy permite que computadores de redes externas se conectem de alguma forma √† rede interna. Esse tipo de conec√ß√£o, pode ser, por exemplo, acessar algum servi√ßo de intranet, FTP, ou fazer SSH para uma m√°quina dentro da rede que n√£o tem acesso externo pelas portas necess√°rias.

	No nosso caso, queremos acessar o precioso <b>servidor com GPU</b> a partir de outra rede. O problema √© que o  <b>servidor com GPU</b> n√£o tem acesso a porta 22 da rede. portanto, tem que passar pela m√°quina proxy. "Graficamente queremos fazer o seguinte:</p>

	<img  src="002.png" width="100%">                                                                                                    


	<h3>Criando um t√∫nel</h3>
	Uma funcionalidade √∫til do SSH √© que ele permite criar t√∫neis. Neste caso, vamos criar um t√∫nel de uma porta do (Meu PC) para uma porta no (Servidor GPU), e claro, isso √© poss√≠vel gra√ßas a (M√°quina Proxy).

	Para abrir um t√∫nel usamos o seguinte arranjo de comandos com o SSH:

	<div class="input_area">
		$ ssh -f -N -X -L <span class="marked">[porta no (Meu PC)]</span>:<span class="marked">[ip ou nome do (Servidor GPU) na rede interna]</span>:<span class="marked">[porta destino no (Server GPU)]</span> <span class="marked">[teu usuario na (M√°quina Proxy)]</span>@<span class="marked">[Endere√ßo da (M√°quina Proxy)]</span>
	</div>
	Exemplo concreto:
	<div class="input_area">
		$ ssh -f -N -X -L 5005:server_gpu:22 fulano@portal.inf.ufrgs.br
	</div>

	Basicamente estamos dizendo para o SSH:  monta um t√∫nel a partir da porta 5005 da minha m√°quina local para a porta 22 (SSH) da m√°quina server_gpu. Tu vais ter que passar pela m√°quina portal.inf.ufrgs.br (M√°quina proxy) usando o usu√°rio fulano.

	√â bom resaltar que n√£o necessariamente o teu usu√°rio vai ser o mesmo na m√°quina server e na m√°quina proxy.

	Bacana, temos um t√∫nel. Aquele monte de op√ß√µes com - na frente indicam que n√£o √© para abrir um terminal bash, criar um t√∫nel e que seja poss√≠vel renderizar janelas remotamente usando servidor X via SSH.


	<h3>Acesso ao bash via SSH</h3>
	Como temos o t√∫nel, basicamente para acessar o terminal da (Servidor GPU) fazemos o seguinte:
	<div class="input_area">
		ssh -Y -p <span class="marked">[porta no (Meu PC) do t√∫nel]</span> <span class="marked">[usu√°rio no (Server GPU)]</span> @localhost
	</div>
	Exemplo concreto:
	<div class="input_area">
		ssh -Y -p 5005 aninha@localhost
	</div>

	Lindo, üò≠, conseguimos conectar pela porta 5005 do (Meu PC) l√° no (Servidor GPU) via SSH  atrav√©s da m√°quina Proxy.


	<h3>Facilitando o acesso aos arquivos</h3>

	Quem j√° sofreu fazendo SCP sabe a chatice que √©, SCP vai, SCP vem... Uma solu√ß√£o para isso √© utilizar o SSHFS, ou seja, file system over SSH ü§©. Com isso √© poss√≠vel criar uma pasta no (Meu PC)  que replica os arquivos de alguma pasta do (Servidor GPU). Assim podemos enviar e copiar os arquivos de forma mais simples e usando o navegador de arquivos com GUI. 

	Eu gosto bastante dessa solu√ß√£o pq permite, por exemplo, que eu edite o c√≥digo no (Server GPU) usando o sublime e posso usar o Finder no OSX para manipular os arquivos/

	Para montar a pasta vamos usar o t√∫nel novamente =) 
	<div class="input_area">
		sshfs -p <span class="marked">porta de entrada do t√∫nel</span> -o allow_other <span class="marked">user na m√°quina desejada</span>@localhost:<span class="marked">path na m√°quina desejada</span> <span class="marked">onde vai ser montado no teu pc</span>
	</div>
	Exemplo concreto:
	<div class="input_area">
		sshfs -p 5005 -o allow_other joao@localhost:/home/joao /home/joao/server_gpu
	</div>
	<p>
	E se tudo der certo, no (Teu PC) agora deve ter uma pasta com os arquivos l√° do (Servidor GPU)

	Exemplo (montado no OSX): </p>

	<img  src="003.png" width="40%">

	<p>B R U X A R I A</p>

	Se tu fores usar as 3 etapas, eu sugiro rodar na ordem: t√∫nel, SSHFS, SSH.  Na real, faz um .sh por favor! üòâ


	<h2>Utilizando Docker com GPUs Nvidia</h2>

	O Docker √© uma ferramenta para empacotar, distribuir e rodar qualquer tipo de aplica√ß√£o dentro de um container. Um container √© independente de hardware e plataforma, ent√£o tu n√£o tens mais aquela desculpa de "na minha m√°quina funciona" hehe. O bacana √© que n√£o temos que nos preocupar se o c√≥digo que estamos criando vai deixar de rodar, por exemplo no server de produ√ß√£o.


	No contexto onde se usa GPUs para esmagar dados, por exemplo, aqui no nosso lab de vis√£o computacional na UFRGS √© interessante usar o Docker para isolar os ambientes e compartilhar hardware (GPUs s√£o caras).  Mas o que √© isolar um ambiente?  Imagina o seguinte, eu estou usando Cuda 9 com cuDNN 7, Tensor Flow, OpenCV 3.4 e Python 3.  Meu colega do lado, que usa o mesmo server, ta usando Cuda 8, cuDNN 5, Torch, OpenCV 2.4 e Python 2.  Se n√£o isolarmos estes ambientes vai dar caca, ou pior, se eu fizer caquinha no meu ambiente, vai repercutir no ambiente do meu colega. Portanto, o Docker pode ser usado para dar essa seguran√ßa de ningu√©m estragar o ambiente de ningu√©m quando se compartilha uma m√°quina. E tu tamb√©m pode fazer uns testes mais "vida loca" j√° que qualquer coisa √© s√≥ subir uma nova imagem. 


	<h3>Uma imagem</h3>
	<img src="ibagens.jpg">

	<p>Uma imagem no Docker √© como se fosse um template para uma m√°quina, que vai ter as libs que tu precisa, os programas, as configura√ß√µes e etc.  O interessante √© que uma vez que se tem a imagem da m√°quina voc√™ pode criar um container dela em qualquer lugar, e esse container vai sempre reproduzir a imagem que deu origem a ele =)</p>  


	<h3>Container</h3>

	Eu n√£o sei explicar isso direito, mas minha melhor interpreta√ß√£o √© que um container √© uma inst√¢ncia de uma imagem Docker que pode, ou n√£o estar rodando atualmente.


	<h3>Como eu crio minha pr√≥pria imagem Docker?</h3>
	N√£o sei. :)

	<h3>Como baixar imagens das internets</h3>
	Uma coisa legal √© que existem reposit√≥rios de imagens Docker com varios setups j√° pr√© configuras. "Ah, tu quer usar Ubuntu 14.4, Cuda 6.0 cuDNN 4. De boas veio, ta aqui a imagem, √© s√≥ dar um pull e usar ai". Exemplo disso √© o <a =href="https://hub.docker.com/">Docker Hub</a>.


	<h3>Interagindo com o Docker</h3>

	Sempre vamos interagir com o o Docker e suas imagens, containers e etc. usando o comando "docker"  ü§™ü§™. Entretanto, para termos suporte ao hardware da NVIDA temos que usar o nvidia-docker (vers√£o Docker da Nvidia que deixa usar a GPU dentro de um container). (Sugiro  que tu crie um alias para o nvidia-docker no teu .bashrc. Eu, ao menos, acho um saco ficar escrevendo essa coisa toda hora üòë).

	<h3>Listando as imagens j√° instaladas no Docker do servidor</h3>

	<i>nvidia-docker images</i>

	A sa√≠da vai ser algo assim:
	<pre>
	REPOSITORY          TAG                            IMAGE ID            CREATED             SIZE
	nvidia/Cuda         9.2-cuDNN7-devel-Ubuntu18.04   4eb54819036b        2 weeks ago         2.92GB
	nvidia/Cuda         latest                         e2728e6295c6        2 weeks ago         1.96GB
	Ubuntu              latest                         113a43faa138        6 weeks ago         81.2MB
	</pre>

	Como podemos ver, temos uma imagem que √© s√≥ Ubuntu, outra que  √© com Cuda basic√£o (nao lembro bem as specs)  e temos  uma imagem que √© bem explicita Cuda 9.2 cuDNN7 para developers  montada no ambiente do Ubuntu 18.04.  (ü§üüèº)


	<h3>Iniciando um container a partir de uma imagem</h3>

	Para inicializar um container a partir de uma imagem √© muito tranquilo:

	<div class="input_area">
		nvidia-docker run --name <span class="marked">nome da instancia</span> -it <span class="marked">IMAGE ID</span> bash
	</div>
	Exemplo concreto:
	<div class="input_area">
		nvidia-docker run --name m√°quina_zeni_experimento_detecta_uncleJ -it 4eb54819036b
	</div>

	<div class="alert">
		SEMPRE INSTACIE UM CONTAINER USANDO o --NAME E DANDO UM NOME QUE FA√áA SENTIDO! 
		Como v√°rias pessoas podem estar usando a mesma m√°quina, pode virar uma bagun√ßa e ningu√©m mais sabe de quem √© o container tal...

		Minha politica como ADM do server: Container mal identificado e n√£o acessado a mais de 7 dias √© assassinado. üî™‚ö∞Ô∏è
	</div>

	<p>E, se tudo der certo, temos acesso a um ambiente Docker como Root =): </p>
	<img src="001.png">

	<div class="alert">
		Uma instancia de um container vai sempre existir ap√≥s a sua instancia√ß√£o (cria√ß√£o), portanto, n√£o √© necess√°rio criar instancias novas toda vez que voc√™ desejar usar o docker. Na realidade, se voc√™ fizer isso n√£o ir√°s manter os arquivos da inst√¢ncia anterior.
	</div>
	<h3>Reiniciando um container criado previamente</h3>
	<div class="input_area">
		$ nvidia-docker start -ai <span class="marked">ID INSTANCIA</span>
	</div>

	Como saber a id da tua inst√¢ncia? ‚è¨

	<h3>Listando os containers que est√£o rodando</h3>
	<div class="input_area">
		$ nvidia-docker ps 
	</div>
	Exemplo dos containers rodando:
	<img src="004.png" width="100%">

	<h3>Listando todos  os containers que existem</h3>
	<div class="input_area">
		$ nvidia-docker ps -a
	</div>
	Exemplo de todos os containers existentes:
	<img src="005.png" width="100%">


	<h3>Dando pull de uma imagem de um reposit√≥rio</h3>
	Voc√™ pode fazer o download de uma imagem contendo as features desejadas em diversos reposit√≥rios, como por exemplo o <a =href="https://hub.docker.com/">Docker Hub</a>.
	
	Um exemplo real: suponha que se quer uma imagem com CUDA + cuDNN v5 + Torch 7 em ambiente Linux (neste caso Ubuntu 14.04). Ap√≥s pesquisar no Docker Hub, encontramos este link: <a href="https://hub.docker.com/r/kaixhin/cuda-torch-mega/">https://hub.docker.com/r/kaixhin/cuda-torch-mega/</a>.
	
	Para dar um pull e instalar essa imagem na m√°quina desejada, digita-se:
	
	<div class="input_area">
		$ docker pull kaixhin/cuda-torch-mega
	</div>
	
	Uma coisa legal do Docker Hub √© que, al√©m de centralizar toda sorte de imagens, ainda h√° espa√ßo para o fornecedor descrever e explicar o funcionamento do ambiente em quest√£o.
	O comando de docker pull, como o do exemplo acima, √© sempre fornecido nessas p√°ginas.

	<h3>Removendo um Container</h3>
	
	Tenha cuidado!
	<div class="input_area">
		$ nvidia-docker rm ID_CONTAINER
	</div>



	<h3>Pessoas que contribuiram com este documento de alguma forma üòÉ (agradecimentos):</h3>
	Thiago Trugillo (Na parte do docker e typos deste documento)
	Seri√£o (Por me ensinar a montar tunneis e sshfs)

</body>
</html>
