<!DOCTYPE html>
<html>
<head>
	<title>Baleia √† cerveja</title>
	<style type="text/css">
    
	li{
		margin-bottom: 10px;
	}

	body {
		margin: 30px;
		padding: 15px;
		background-color: #fff;
		min-height: 0;
		-webkit-box-shadow: 0px 0px 12px 1px rgba(87, 87, 87, 0.2);
		box-shadow: 0px 0px 12px 1px rgba(87, 87, 87, 0.2);
	}


	.alert{
		padding: 15px;
		margin-bottom: 18px;
		border: 1px solid transparent;
		border-radius: 2px;
		background: lightyellow;
		color: red;
	}


	.marked{
		text-decoration: underline;
	}

	.input_area {
		border: 1px solid #cfcfcf;
		border-radius: 2px;
		background: #f7f7f7;
		line-height: 1.21429em;
		padding: 10px;
		margin-bottom: 10px;
		margin-top: 10px;
	}

	</style>
</head>
<body>

	<h1> Acesso remoto √† um servidor linux com suporte a GPU e Docker</h1>

	Contribui√ß√µes s√£o bem vindas. Sugira melhorias, typos, me de bitcoins!

	Este tutorial √© uma <u>tentativa</u> de registrar as coisas (comandos, artimanhas e mutretas) mais "b√°sicas" para acessar remotamente um servidor linux que tenha suporte a GPU e Docker. Observe que eu n√£o vou entrar em detalhes  de como instalar e configurar tal ambiente.

	O Tutorial esta separado em duas se√ß√µes:
	<ol>
		<li>Como fazer o acesso remoto com tunnelamento e montar uma pasta para acessar os arquivos no server</li>
		<li>Como usar o docker em conjunto com a GPU</li>
	</ol>


	<h2>Acesso remoto ao servidor</h2>

	<p>Tentarei listar o que acho necess√°rio para se concectar "confort√°velmente" em um server linux remoto usando SSH. √â provavel que algumas explica√ß√µes sejam omitida ou pq eu sou pregui√ßoso o pq esqueci de faze-lo. Lembra-te que esta √© <i> my way to do </i> existem outras formas e vc √© livre para escolher a que mais achares interessante üòÑ.

	Acessar SSH dentro de uma mesma rede usando linux √© trivial e n√£o irei entrar em detalhes para este tipo de acesso. Aqui iremos discutir um contexto um pouco mais complexo, existe uma maquina de ponto de entrada para a rede (chamaremos de <b>Maquina Proxy</b> aqui), em resumo, maquina Proxy permite que computadores de redes externas se conectem de alguma forma a rede interna. Esse tipo de cone√ß√£o poderia ser acessar algum servi√ßo de intranet, ftp, ou fazer ssh para uma maquina dentro desta rede.

	No nosso caso, queremos acessar o precioso <b>servidor com GPU</b> que esta nesta rede e o acesso a ela, se feito fora da rede, tem que passar pela maquina proxy. ""Graficamente queremos fazer o seguinte:</p>

	<img  src="002.png" width="100%">                                                                                                    


	<h3>Criando um t√∫nel</h3>
	Uma funcionalidade √∫til do SSH √© que ele permite criar tuneis, no caso vamos criar um t√∫nel de uma porta do (Meu PC) para uma porta no (Servidor GPU), e claro, isso √© poss√≠vel gra√ßas a (Maquina Proxy).

	Para abrir um t√∫nel usamos o seguinte arranjo de comandos com o ssh:

	<div class="input_area">
		$ ssh -f -N -X -L <span class="marked">[porta no (Meu PC)]</span>:<span class="marked">[ip ou nome do (Servidor GPU) na rede interna]</span>:<span class="marked">[porta destino no (Server GPU)]</span> <span class="marked">[teu usuario na (Maquina Proxy)]</span>@<span class="marked">[Endere√ßo da (Maquina Proxy)]</span>
	</div>
	Exemplo concreto:
	<div class="input_area">
		$ ssh -f -N -X -L 5005:server_gpu:22 fulano@portal.inf.ufrgs.br
	</div>

	Basicamente estamos dizendo para o ssh:  monta um t√∫nel a partir da porta 5005 da minha maquina local para a porta 22 (SSH) da maquina server_gpu. Tu vai ter que passar pela maquina portal.inf.ufrgs.br (Maquina proxy) usando o usu√°rio fulano.

	√â bom resaltar que n√£o necessariamente o teu usu√°rio vai ser o mesmo na maquina server e na maquina proxy.

	Bacana, temos um t√∫nel, aquele monte de op√ß√µes na frente indicam que n√£o √© p/ abrir um terminal bash, criar um tunel e que seja possivel renderizar janelas remotamente usando servidor X via ssh.


	<h3>Acesso ao bash via ssh</h3>
	Como temos o t√∫nel, basicamente para acessar o terminal da maquina fazemos o seguinte:
	<div class="input_area">
		ssh -Y -p <span class="marked">[porta no (Meu PC) do t√∫nel]</span> <span class="marked">[usu√°rio no (Server GPU)]</span> @localhost
	</div>
	Exemplo concreto:
	<div class="input_area">
		ssh -Y -p 5005 aninha@localhost
	</div>

	Lindo, üò≠, conseguimos conectar pela porta 5005 do (Meu PC) l√° no (Servidor GPU) via ssh  atravez da m√°quina Proxy.


	<h3>Facilitando o acesso aos arquivos</h3>

	Quem j√° sofreu fazendo scp sabe a chatice que √©, scp vai, scp vem... Uma solu√ß√£o para isso √© utilizar o sshfs, ou seja, file system over ssh ü§©. Com isso √© possivel criar uma pasta no (Meu PC)  que replica os arquivos de alguma pasta do (Servidor GPU). Assim podemos enviar e copiar os arquivos de forma mais simples.

	Para fazer isso vamos usar o t√∫nel novamente =) 
	<div class="input_area">
		sshfs -p <span class="marked">porta de entrada do t√∫nel</span> -o allow_other <span class="marked">user na maquina desejada</span>@localhost:<span class="marked">path na maquina desejada</span> <span class="marked">onde vai ser montado no teu pc</span>
	</div>
	Exemplo concreto:
	<div class="input_area">
		sshfs -p 5005 -o allow_other joao@localhost:/home/joao /home/joao/server_gpu
	</div>
	<p>
	E se tudo der certo, no (Teu PC) agora deve ter uma pasta que tem os arquivos l√° do (Servidor GPU)

	Exemplo (montado no osx): </p>

	<img  src="003.png" width="40%">

	<p>B R U X A R I A</p>

	Se tu fores usar as 3 etapas, eu sugiro rodar na ordem tunel, sshfs, ssh.  Na real, faz um .sh por favor! üòâ


	<h2>Utilizando docker com GPUs Nvidia</h2>

	O docquer √© uma ferramenta para empacotar, distribuir e rodar qualquer tipo de aplica√ß√£o dentro de um container. Um container √© independente de hardware e plataforma, ent√£o tu n√£o tem mais aquela desculpa de na minha maquina funciona hehe. O bacana √© que n√£o temos que nos preocupar se o c√≥digo que estamos criando vai deixar de rodar, por exemplo no server de produ√ß√£o.


	No contexto onde se usa GPUs, por exemplo aqui no nosso lab de vis√£o computacional na UFRGS √© interessante usar o docker para isolar os ambientes. Como sabemos uma GPU √© cara para burro e ainda bem que a Nvidia doou umas para n√≥s =). Mas o que √© isolar o ambiente?  Imagina o seguinte, eu to usando cuda 9 com cudnn 7, tensor flow, opencv 3.4 e python 3.  Meu colega do lado, que usa o mesmo server, ta usando cuda 8, cudnn 5, torch, opencv 2.4 e python 2.  Se n√£o isolarmos estes ambientes vai dar caca, ou pior, se eu fizer caquinha no meu ambiente, vai repercutir no ambiente do meu colega. Portanto, o docker pode ser usado para dar essa seguran√ßa de ninguem estragar o ambiente de ninguem quando se compartilha uma maquina. E tu tbm pode fazer uns testes mais "vida loca" j√° que qualquer coisa √© s√≥ subir uma nova imagem.


	<h3>Uma imagem</h3>
	<img src="ibagens.jpg">

	<p>Uma imagem no docker √© como se fosse um template para uma maquina, vai ter as libs que tu precisa, os programas, as configura√ß√µes e etc.  O interessante √© que uma vez que se tem a imagem da maquina voc√™ pode criar um container dela em qualquer lugar, e esse container vai sempre reproduzir a imagem que deu origem a ele =)</p>  


	<h3>Container</h3>

	Eu n√£o sei explicar isso direito, mas minha melhor interpreta√ß√£o √© que um container √© uma inst√¢ncia de uma imagem docker que pode, ou n√£o estar rodando atualmente.


	<h3>Como eu crio minha pr√≥pria imagem Docker?</h3>
	N√£o sei. :)

	<h3>Como baixar imagens das internets</h3>
	Uma coisa legal √© que existem reposit√≥rios de imagens Docker com varios setups j√° pr√© configuras. "Ah, tu quer usar ubuntu 14.4, cuda 6.0 cudnn 4. De boas veio ta aqui a imagem, √© s√≥ dar um pull e usar ai"


	<h3>Interagindo com o docker</h3>

	Sempre vamos interagir com o o docker e suas imagens, containers e etc usando o comando "docker"  ü§™ü§™. Entretanto, para termos suporte ao hardware da NVIDA temos que usar o nvidia-docker (vers√£o docker da Nvidia que deixa usar a GPU dentro de um container). (Sugiro  que tu crie um alias para o nvidia-docker no teu .bashrc, eu, ao menos, acho um saco ficar escrevendo essa coisa toda hora üòë).

	<h3>Listando as imagens j√° instaladas no docker do servidor</h3>

	<i>nvidia-docker images</i>

	A saida vai ser algo assim:
	<pre>
	REPOSITORY          TAG                            IMAGE ID            CREATED             SIZE
	nvidia/cuda         9.2-cudnn7-devel-ubuntu18.04   4eb54819036b        2 weeks ago         2.92GB
	nvidia/cuda         latest                         e2728e6295c6        2 weeks ago         1.96GB
	ubuntu              latest                         113a43faa138        6 weeks ago         81.2MB
	</pre>

	como podemos ver temos uma imagem que √© s√≥ ubuntu, outra que  √© com cuda basicao (nao lembro bem as specs)  e temps  uma imagem que √© bem explicita cuda 9.2 cudnn7 para developers  montada no ambiente do ubuntu18.04.  (ü§üüèº)


	<h3>Iniciando um container a partir de uma imagem</h3>

	Para inicializar um container a partir de uma imagem √© mto tranquilo:

	<div class="input_area">
		nvidia-docker run --name <span class="marked">nome da instancia</span> -it <span class="marked">IMAGE ID</span> bash
	</div>
	Exemplo concreto:
	<div class="input_area">
		nvidia-docker run --name maquina_zeni_experimento_detecta_uncleJ -it 4eb54819036b
	</div>

	<div class="alert">
		SEMPRE INSTACIE UM CONTAINER USANDO o --NAME E DANDO UM NOME QUE FA√áA SENTIDO! 
		Como v√°rias pessoas podem estar usando a mesma maquina pode virar uma bagun√ßa e ninguem mais sabe de quem √© o container tal...

		Minha politica como ADM do server: Container mal identificado e n√£o acessado a mais de 7 dias √© assassinado. üî™‚ö∞Ô∏è
	</div>

	<p>E, se tudo der certo, temos acesso a um ambiente docker como Root =): </p>
	<img src="001.png">

	<h3>Listando os containers que est√£o rodando</h3>
	<div class="input_area">
		$ nvidia-docker ps 
	</div>
	Exemplo dos containers rodando:
	<img src="004.png" width="100%">

	<h3>Listando todos  os containers que existem</h3>
	<div class="input_area">
		$ nvidia-docker ps -a
	</div>
	Exemplo de todos os containers existentes:
	<img src="005.png" width="100%">


	<h3>Dando push de uma imagem de um reposit√≥rido</h3>
	TODO, sorry üòÖ

	<h3>Removendo um Container</h3>
	
	Tenha cuidado!
	<div class="input_area">
		$ nvidia-docker rm ID_CONTAINER
	</div>


</body>
</html>